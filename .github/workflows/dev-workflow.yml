name: get file changes
on:
  push:
    branches:
      - master
    paths:
      - 'update_query.txt'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: checking git diff
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
      - name: feching git data
        id: diffData
        run: |
          data=$(git diff ${{ github.event.before }} ${{ github.sha }} --no-ext-diff --unified=0 --exit-code -a --no-prefix | grep "^\+" | sed -E 's/^\+//' | sed '/^#/d')
          data="${data//'%'/'%25'}"
          data="${data//$'\n'/'%0A'}"
          data="${data//$'\r'/'%0D'}"
          echo "::set-output name=test::data"
#        run: git diff ${{ github.event.before }} ${{ github.sha }} --no-ext-diff --unified=0 --exit-code -a --no-prefix | grep "^\+" | sed -E 's/^\+//'
      - name: checking env variable and curl
#        run: echo ${{ steps.diffData.outputs.test }}
#        env:
#          UPDATE_QUERIES_DATA: ${{ steps.diffData.outputs.test }}
        run: |
          curl -X POST -u api_user:password http://3228c09c80bc.ngrok.io/v1/account -H "content-type: application/json" -d "{ \"parameters\": { \"migration_cmd\": \"update\" }, \"input\": \"${{ steps.diffData.outputs.test }}\" }"
# curl -X POST -u SPINNAKER_USERNAME:SPINNAKER_PASSWORD https://deploy-api.razorpay.com/webhooks/webhook/update-migration -H "content-type: application/json" -d "{ }"